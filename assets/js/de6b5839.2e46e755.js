"use strict";(self.webpackChunkbratislava_github_io=self.webpackChunkbratislava_github_io||[]).push([[6199],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>k});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},l=Object.keys(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var c=r.createContext({}),i=function(e){var t=r.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=i(e.components);return r.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=i(a),k=n,d=m["".concat(c,".").concat(k)]||m[k]||u[k]||l;return a?r.createElement(d,o(o({ref:t},p),{},{components:a})):r.createElement(d,o({ref:t},p))}));function k(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,o=new Array(l);o[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var i=2;i<l;i++)o[i]=a[i];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},1637:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>i});var r=a(7462),n=(a(7294),a(3905));const l={},o="Application Backups",s={unversionedId:"deployment-and-infrastructure/backups",id:"deployment-and-infrastructure/backups",title:"Application Backups",description:"For backups we are using standalone installation of Velero with restic on our Tanzu kubernetes clusters (info).",source:"@site/docs/deployment-and-infrastructure/backups.md",sourceDirName:"deployment-and-infrastructure",slug:"/deployment-and-infrastructure/backups",permalink:"/docs/deployment-and-infrastructure/backups",draft:!1,editUrl:"https://github.com/bratislava/bratislava.github.io/edit/master/docs/deployment-and-infrastructure/backups.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Deployment and Infrastructure",permalink:"/docs/category/deployment-and-infrastructure"},next:{title:"Database backups",permalink:"/docs/deployment-and-infrastructure/database-backups"}},c={},i=[{value:"Description",id:"description",level:2},{value:"Installation",id:"installation",level:2},{value:"Usage",id:"usage",level:2},{value:"\ud83d\udcbe To make a backup with Velero",id:"-to-make-a-backup-with-velero",level:3},{value:"\ud83d\udd5b To make repeating backup with Velero",id:"-to-make-repeating-backup-with-velero",level:3},{value:"\u23ea To restore backup with Velero",id:"-to-restore-backup-with-velero",level:3}],p={toc:i};function u(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,r.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"application-backups"},"Application Backups"),(0,n.kt)("p",null,"For backups we are using standalone installation of ",(0,n.kt)("a",{parentName:"p",href:"https://velero.io/"},"Velero")," with ",(0,n.kt)("a",{parentName:"p",href:"https://restic.net/"},"restic")," on our Tanzu kubernetes clusters (",(0,n.kt)("a",{parentName:"p",href:"https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/GUID-A24A6B91-0CDF-4D02-AD08-7BA5EAC25A42.html"},"info"),")."),(0,n.kt)("h2",{id:"description"},"Description"),(0,n.kt)("p",null,"Velero creates a ",(0,n.kt)("em",{parentName:"p"},"custom resource")," ",(0,n.kt)("strong",{parentName:"p"},"velero.io")," on kubernetes cluster, where it's stores all of it information about backups, schedules, restores, ",(0,n.kt)("em",{parentName:"p"},"backup locations"),', etc. We are using S3 buckets as a storage, which were configured during installation and can be found in "velero.io/BackupStorageLocation" and can be listed by running '),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get backupstoragelocation --all-namespaces\n")),(0,n.kt)("p",null,"Currently, we are running daily backups of only most important infrastructure, but this is subject to change in the future. All cluster with Velero installed and correctly configured backup locations can access all backups throughout all clusters. Meaning you can make a backup on ",(0,n.kt)("em",{parentName:"p"},'"prod"')," cluster and restore it on ",(0,n.kt)("em",{parentName:"p"},'"dev"'),". This is possible since we are using ",(0,n.kt)("a",{parentName:"p",href:"https://restic.net/"},"restic")," to actually make backups of files and persistent volumes. Restic uses generic format to store data and therefore our backups should be portable between cluster, different infrastructures or kubernetes version. This allows us, in case of emergency, to spin up an emergency cluster and restore entire infrastructure if needed. "),(0,n.kt)("p",null,"The critical services are labeled ",(0,n.kt)("inlineCode",{parentName:"p"},"critical=true"),", which you can use as selector when restoring a backups."),(0,n.kt)("h2",{id:"installation"},"Installation"),(0,n.kt)("p",null,"To use Velero, you need to install it's CLI client, which can be found ",(0,n.kt)("a",{parentName:"p",href:"https://velero.io/docs/v1.8/basic-install/#install-the-cli"},"here"),".",(0,n.kt)("br",{parentName:"p"}),"\n","To validate if Velero is correctly install, you can run"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero help\n")),(0,n.kt)("p",null,"which should list all available commands. By default ",(0,n.kt)("inlineCode",{parentName:"p"},"velero")," will use your current kubeconfig and ",(0,n.kt)("inlineCode",{parentName:"p"},"current-context")," cluster. To check if everything is working with our infrastructure you can run"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero get backups\n")),(0,n.kt)("p",null,"which no matter what cluster you are connected to, should list the same backups."),(0,n.kt)("p",null,"As we are using S3 as backup locations, it is advisable to also install tools, that can work with S3 bucket, such as"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"},"aws cli")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/peak/s5cmd"},"s5cmd")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://s3browser.com/"},"S3 browser"))),(0,n.kt)("h2",{id:"usage"},"Usage"),(0,n.kt)("p",null,"Here is a non exhaustive list of examples, how to work with Velero"),(0,n.kt)("h3",{id:"-to-make-a-backup-with-velero"},"\ud83d\udcbe To make a backup with Velero"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero backup create app-namespace-backup-$(date -I) --include-namespaces my-app-namespace\n")),(0,n.kt)("p",null,"which will create a backup of entire namespace ",(0,n.kt)("inlineCode",{parentName:"p"},"my-app-namespace")," with name ",(0,n.kt)("inlineCode",{parentName:"p"},'"app-namespace-backup-2022-01-01"')," (if it would be ran on date 2022-01-01)."),(0,n.kt)("h3",{id:"-to-make-repeating-backup-with-velero"},"\ud83d\udd5b To make repeating backup with Velero"),(0,n.kt)("p",null,"you can create ",(0,n.kt)("a",{parentName:"p",href:"https://velero.io/docs/main/backup-reference/#schedule-a-backup"},(0,n.kt)("inlineCode",{parentName:"a"},"schedule"))),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'velero schedule create app-namespace-backup --include-namespaces my-app-namespace --schedule="0 0 * * *"\n')),(0,n.kt)("p",null,"which will create a daily backup, each day at 00:00AM, of ",(0,n.kt)("inlineCode",{parentName:"p"},"my-app-namespace")," kubernetes namespace."),(0,n.kt)("h3",{id:"-to-restore-backup-with-velero"},"\u23ea To restore backup with Velero"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero restore create my-app-restore --from-backup app-namespace-backup\n")),(0,n.kt)("p",null,"or restore from schedule"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero restore create my-app-restore --from-schedule app-namespace-backup\n")),(0,n.kt)("p",null,"which will restore the latest backup made from given schedule.",(0,n.kt)("br",{parentName:"p"}),"\n","You can also use standard kubectl syntax and specify selector when creating a backup, restore, etc. For example, to restore only critical services from ",(0,n.kt)("inlineCode",{parentName:"p"},'"backup123"')),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"velero restore create --from-backup backup-123 --selector=critical=true\n")),(0,n.kt)("p",null,"More information and examples can be found in"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"VMWare Tanzu ",(0,n.kt)("a",{parentName:"li",href:"https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/GUID-9816E07A-466C-451D-A43B-D415B2FAB7D6.html"},"documentation")),(0,n.kt)("li",{parentName:"ul"},"Official Velero ",(0,n.kt)("a",{parentName:"li",href:"https://velero.io/docs/v1.10/backup-reference/"},"documentation"))))}u.isMDXComponent=!0}}]);