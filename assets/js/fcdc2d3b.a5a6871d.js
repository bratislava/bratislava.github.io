"use strict";(self.webpackChunkbratislava_github_io=self.webpackChunkbratislava_github_io||[]).push([[1543],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>d});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(a),d=r,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},747:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const o={},i="Alerting on Application Logs",l={unversionedId:"recipes/alerting/log_alert",id:"recipes/alerting/log_alert",title:"Alerting on Application Logs",description:'In this section we discuss how to build a alert on top of your application logs. As an example, we will fire a alert, when we see "ERROR" keyword in the logs of our application.',source:"@site/docs/recipes/alerting/log_alert.md",sourceDirName:"recipes/alerting",slug:"/recipes/alerting/log_alert",permalink:"/docs/recipes/alerting/log_alert",draft:!1,editUrl:"https://github.com/bratislava/bratislava.github.io/edit/master/docs/recipes/alerting/log_alert.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Alerting on Endpoint Availability or Request Data (HTTP Request)",permalink:"/docs/recipes/alerting/endpoint_alert"},next:{title:"Alerting on Resources Utilization",permalink:"/docs/recipes/alerting/resource_alert"}},s={},p=[{value:"Examples",id:"examples",level:2}],c={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"alerting-on-application-logs"},"Alerting on Application Logs"),(0,r.kt)("p",null,"In this section we discuss how to build a alert on top of your application logs. As an example, we will fire a alert, when we see ",(0,r.kt)("inlineCode",{parentName:"p"},'"ERROR"')," keyword in the logs of our application.",(0,r.kt)("br",{parentName:"p"}),"\n","To build such a log alert we need to "),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"First go to ",(0,r.kt)("a",{parentName:"p",href:"https://grafana.bratislava.sk/alerting/list"},"Alert section"),' in Grafana (bell icon on the left menu). Then hit the "+ New alert rule" button.\n',(0,r.kt)("img",{alt:"create new alert",src:a(1288).Z,title:"Create new alert from alert menu",width:"1583",height:"545"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fill in the metadata of rule"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Rule name"),", give it what ever you feel is descriptive"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Folder"),", select based on the cluster"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Group"),", you can put anything in place of a group, like project name",(0,r.kt)("br",{parentName:"li"}),(0,r.kt)("em",{parentName:"li"},"Bear in mind that all alerts within the same group will be evaluated at the same time. So, if you are planing on creating more alerts for one project, we would suggest to give it the name of that project or something similar")))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'Next, in the second section we need to change the dataset from "Prometheus" to "Loki". Optionally, we can also change name of expression from "A" to maybe something more descriptive.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"We also need to change the time span on which we are going to alert on. We need to select ",(0,r.kt)("inlineCode",{parentName:"p"},'"now-1h to now"'),", other options are not available or not work well in the current Grafana implementation (",(0,r.kt)("a",{parentName:"p",href:"https://github.com/grafana/grafana/issues/48913"},"Issue #48913"),")\n",(0,r.kt)("img",{alt:"change Loki dataset",src:a(5694).Z,title:"Select Loki Dataset",width:"1500",height:"105"})," ")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Now for the hard part, we need to build ",(0,r.kt)("a",{parentName:"p",href:"https://grafana.com/docs/loki/latest/logql/"},"Loki query"),". The query language can do a lot of things, but for monitoring on simple phrases we just need a simple expression that selects our application within ",(0,r.kt)("inlineCode",{parentName:"p"},"{}"),", wrapped in ",(0,r.kt)("inlineCode",{parentName:"p"},"count_over_time")," function.",(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},'count_over_time({cluster="tkg-innov-prod", namespace="standalone", app="example-app"} |= "ERROR" [10m])'),(0,r.kt)("br",{parentName:"p"}),"\n","After ",(0,r.kt)("inlineCode",{parentName:"p"},"{}")," selection, we have ",(0,r.kt)("inlineCode",{parentName:"p"},"|="),' operator, which matches exactly the expression "ERROR". But, we can also do ',(0,r.kt)("inlineCode",{parentName:"p"},"|~")," operator, which is capable matching on regex expressions.",(0,r.kt)("br",{parentName:"p"}),"\n",'This expression select logs only for our specific application then matches the string "ERROR", and over time of 10 minutes counts the number of occurrences of that string.',(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("em",{parentName:"p"},'Note, that you can use "Explore" (compass icon in left menu) UI to build and test your queries.'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Then the process is very similar to the one that is describe in ",(0,r.kt)("a",{parentName:"p",href:"/docs/recipes/alerting/resource_alert"},'"Alert on resources"')," section, steps 7. onwards. We need to create two more expressions, one with ",(0,r.kt)("inlineCode",{parentName:"p"},"Operation"),' "Reduce" and the next with ',(0,r.kt)("inlineCode",{parentName:"p"},"Operation"),' "Math".  '),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},'For "Reduce", we want to select "Last" function, which ',(0,r.kt)("em",{parentName:"li"},"reduces")," our query to last know value  "),(0,r.kt)("li",{parentName:"ul"},'For "Math", we want to put our ',(0,r.kt)("a",{parentName:"li",href:"https://grafana.com/docs/grafana/latest/panels/query-a-data-source/use-expressions-to-manipulate-data/about-expressions/#math"},"math expression"),", in our case,\nwe want to alert on ",(0,r.kt)("strong",{parentName:"li"},"any one"),' occurrence of "ERROR". Meaning,  ',(0,r.kt)("inlineCode",{parentName:"li"},"$last_count_log >= 1"),' (notice, we renamed our "Reduce" expression to ',(0,r.kt)("inlineCode",{parentName:"li"},"last_count_log"),", for better readability)\n",(0,r.kt)("img",{alt:"log alert count",src:a(7405).Z,title:"Log alerts expression",width:"1458",height:"443"})))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},'We need define alert condition. Select the name of our "Math" expression and set check interval (',(0,r.kt)("inlineCode",{parentName:"p"},"Evaluate"),"). Also, set for how long should the alert be pending before firing (",(0,r.kt)("inlineCode",{parentName:"p"},"for"),").")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Lastly, we give the alert description and summary, and if needed we put specific labels to help us quickly understand which error is firing when we get a notification.\n",(0,r.kt)("img",{alt:"log alert details",src:a(5035).Z,title:"Details for our log alert",width:"693",height:"575"}),"\n",(0,r.kt)("em",{parentName:"p"},"Note, you can use ",(0,r.kt)("a",{parentName:"em",href:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/annotation-label/variables-label-annotation/"},"template")," variables to customize your alert details, as seen on the picture above.")))),(0,r.kt)("p",null,"And that is it. Now you can just ",(0,r.kt)("font",{color:"white",style:{backgroundColor:"#3871dc",padding:"2px"}},(0,r.kt)("strong",{parentName:"p"},'"Save and exit"')),", and your alert should be running, and firing in case of any issues.",(0,r.kt)("br",{parentName:"p"}),"\n","The default contact point is through Slack to ",(0,r.kt)("inlineCode",{parentName:"p"},"grafana-alerting")," channel. If you want to receive your alerts somewhere else or through some other means, please checkout ",(0,r.kt)("a",{parentName:"p",href:"/docs/recipes/alerting/contact-point"},'"How to add Contact Point"')," recipe."),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://grafana.bratislava.sk/alerting/grafana/FuuQK0n4k/view?returnTo=%2Falerting%2Flist"},"Log alert"),' on specific keyword. This is the example alert for one of our application, that fires every time we see the "ERROR" string in the logs of said application.')))}u.isMDXComponent=!0},5694:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/change_loki_dataset-775f130a1169eb899f4cde65853c7cef.png"},1288:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create_new_alert-b683d26df2c034d96ebe33dd15782992.png"},7405:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/log_count_errors-73b984d1e1f79aaf11f6e6a59b807a1d.png"},5035:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/summary_description_labels_for_logs-2d14428f239a62577baaa6a51523d752.png"}}]);