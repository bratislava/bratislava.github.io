(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5132],{365:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/deployment-and-infrastructure/deployment-and-releases",function(){return t(9917)}])},9369:function(e,n,t){"use strict";var a=t(5893);t(7294);let i={logo:(0,a.jsx)("span",{children:"\uD83D\uDCDA Bratislava Documentation"}),project:{link:"https://github.com/bratislava"},docsRepositoryBase:"https://github.com/bratislava/bratislava.github.io",sidebar:{defaultMenuCollapseLevel:0},footer:{text:"Department of Innovation and Technology of the City of Bratislava"},faviconGlyph:"\uD83D\uDCDA"};n.Z=i},9917:function(e,n,t){"use strict";t.r(n);var a=t(5893),i=t(2673),r=t(4376),s=t(9369);t(9966);var o=t(1151);t(5675);let d={MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,o.ah)(),e.components);return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)},pageOpts:{filePath:"pages/deployment-and-infrastructure/deployment-and-releases.md",route:"/deployment-and-infrastructure/deployment-and-releases",headings:[{depth:1,value:"Deployment & Releases",id:"deployment--releases"},{depth:2,value:"Production releases",id:"production-releases"},{depth:3,value:"Frontend / Backend apps",id:"frontend--backend-apps"},{depth:4,value:"DEV and STAGING deployments",id:"dev-and-staging-deployments"},{depth:4,value:"PROD deployments",id:"prod-deployments"},{depth:3,value:"Libraries",id:"libraries"},{depth:4,value:"Do's and Don'ts",id:"dos-and-donts"},{depth:3,value:"Native",id:"native"},{depth:2,value:"Manual deployment using bratiska-cli",id:"manual-deployment-using-bratiska-cli"},{depth:2,value:"Harbor Policies",id:"harbor-policies"}],pageMap:[{kind:"MdxPage",name:"GINIS",route:"/GINIS"},{kind:"Meta",data:{index:"Introduction",onboarding:"Setup & Onboarding","-- Eslint --":{type:"separator"},"eslint-and-prettier":"Eslint & Prettier","-- Web development --":{type:"separator"},frontend:"Frontend",strapi:"Strapi",graphql:"GraphQL",meilisearch:"Meilisearch",openapi:"OpenAPI client","-- Backend --":{type:"separator"},GINIS:"GINIS",nestjs:"NestJS","-- DevOps --":{type:"separator"},"deployment-and-infrastructure":"Deployment & Infrastructure","monitoring-and-observability":"Monitoring & Observability","-- Projects --":{type:"separator"},"bratislava.sk":"bratislava.sk","konto.bratislava.sk":"konto.bratislava.sk","muzeumbratislava.sk":"muzeumbratislava.sk"}},{kind:"Folder",name:"bratislava.sk",route:"/bratislava.sk",children:[{kind:"MdxPage",name:"add-new-component-to-sections",route:"/bratislava.sk/add-new-component-to-sections"},{kind:"MdxPage",name:"meilisearch-setup",route:"/bratislava.sk/meilisearch-setup"},{kind:"Meta",data:{"add-new-component-to-sections":"Add New Component to Sections","meilisearch-setup":"Meilisearch Setup"}}]},{kind:"Folder",name:"deployment-and-infrastructure",route:"/deployment-and-infrastructure",children:[{kind:"MdxPage",name:"backups",route:"/deployment-and-infrastructure/backups"},{kind:"MdxPage",name:"connecting-to-kubernetes",route:"/deployment-and-infrastructure/connecting-to-kubernetes"},{kind:"MdxPage",name:"database-backups",route:"/deployment-and-infrastructure/database-backups"},{kind:"MdxPage",name:"debug-cluster-connectivity",route:"/deployment-and-infrastructure/debug-cluster-connectivity"},{kind:"MdxPage",name:"deployment-and-releases",route:"/deployment-and-infrastructure/deployment-and-releases"},{kind:"MdxPage",name:"env-vars-and-secrets",route:"/deployment-and-infrastructure/env-vars-and-secrets"},{kind:"Meta",data:{backups:"Backups","connecting-to-kubernetes":"Connecting to Kubernetes","database-backups":"Database Backups","debug-cluster-connectivity":"Debug Cluster Connectivity","deployment-and-releases":"Deployment and Releases","env-vars-and-secrets":"Env Vars and Secrets"}}]},{kind:"MdxPage",name:"eslint-and-prettier",route:"/eslint-and-prettier"},{kind:"Folder",name:"frontend",route:"/frontend",children:[{kind:"Meta",data:{components:{title:"Components"},svg:{title:"SVG setup"},captcha:{display:"hidden",title:"Captcha"},"data-fetching-listing":{title:"Data fetching & listing",display:"hidden"},"date-and-time":{title:"Date & time",display:"hidden"},fonts:{display:"hidden",title:"Fonts"},gallery:{display:"hidden",title:"Gallery"},icons:{display:"hidden",title:"Icons"},images:{display:"hidden",title:"Images"},localization:{display:"hidden",title:"Localization"},menu:{display:"hidden",title:"Menu"},"navigation-breadcrumbs":{title:"Navigation & breadcrumbs",display:"hidden"},search:{display:"hidden",title:"Search"},seo:{display:"hidden",title:"Seo"},texts:{display:"hidden",title:"Texts"}}},{kind:"MdxPage",name:"captcha",route:"/frontend/captcha"},{kind:"Folder",name:"components",route:"/frontend/components",children:[{kind:"Meta",data:{cards:{title:"Cards"},links:{display:"hidden",title:"Links"},modals:{display:"hidden",title:"Modals"},tables:{display:"hidden",title:"Tables"}}},{kind:"MdxPage",name:"cards",route:"/frontend/components/cards"},{kind:"MdxPage",name:"links",route:"/frontend/components/links"},{kind:"MdxPage",name:"modals",route:"/frontend/components/modals"},{kind:"MdxPage",name:"tables",route:"/frontend/components/tables"}]},{kind:"MdxPage",name:"components",route:"/frontend/components"},{kind:"MdxPage",name:"data-fetching-listing",route:"/frontend/data-fetching-listing"},{kind:"MdxPage",name:"date-and-time",route:"/frontend/date-and-time"},{kind:"MdxPage",name:"fonts",route:"/frontend/fonts"},{kind:"MdxPage",name:"gallery",route:"/frontend/gallery"},{kind:"MdxPage",name:"icons",route:"/frontend/icons"},{kind:"MdxPage",name:"images",route:"/frontend/images"},{kind:"MdxPage",name:"localization",route:"/frontend/localization"},{kind:"MdxPage",name:"menu",route:"/frontend/menu"},{kind:"MdxPage",name:"navigation-breadcrumbs",route:"/frontend/navigation-breadcrumbs"},{kind:"MdxPage",name:"search",route:"/frontend/search"},{kind:"MdxPage",name:"seo",route:"/frontend/seo"},{kind:"MdxPage",name:"svg",route:"/frontend/svg"},{kind:"MdxPage",name:"texts",route:"/frontend/texts"}]},{kind:"MdxPage",name:"graphql",route:"/graphql"},{kind:"MdxPage",name:"index",route:"/"},{kind:"Folder",name:"konto.bratislava.sk",route:"/konto.bratislava.sk",children:[{kind:"MdxPage",name:"forms-general",route:"/konto.bratislava.sk/forms-general"},{kind:"MdxPage",name:"forms-uischema",route:"/konto.bratislava.sk/forms-uischema"},{kind:"MdxPage",name:"forms-upload-file",route:"/konto.bratislava.sk/forms-upload-file"},{kind:"Meta",data:{"forms-general":"Forms General","forms-uischema":"Forms Uischema","forms-upload-file":"Forms Upload File"}}]},{kind:"MdxPage",name:"meilisearch",route:"/meilisearch"},{kind:"Folder",name:"monitoring-and-observability",route:"/monitoring-and-observability",children:[{kind:"Folder",name:"alerting",route:"/monitoring-and-observability/alerting",children:[{kind:"MdxPage",name:"contact-point",route:"/monitoring-and-observability/alerting/contact-point"},{kind:"MdxPage",name:"endpoint_alert",route:"/monitoring-and-observability/alerting/endpoint_alert"},{kind:"MdxPage",name:"grafana_alerting",route:"/monitoring-and-observability/alerting/grafana_alerting"},{kind:"MdxPage",name:"log_alert",route:"/monitoring-and-observability/alerting/log_alert"},{kind:"MdxPage",name:"resource_alert",route:"/monitoring-and-observability/alerting/resource_alert"},{kind:"Meta",data:{"contact-point":"Contact Point",endpoint_alert:"Endpoint Alert",grafana_alerting:"Grafana Alerting",log_alert:"Log Alert",resource_alert:"Resource Alert"}}]},{kind:"MdxPage",name:"grafana",route:"/monitoring-and-observability/grafana"},{kind:"Meta",data:{grafana:"Grafana"}}]},{kind:"Folder",name:"muzeumbratislava.sk",route:"/muzeumbratislava.sk",children:[{kind:"MdxPage",name:"new-year-update",route:"/muzeumbratislava.sk/new-year-update"},{kind:"Meta",data:{"new-year-update":"New Year Update"}}]},{kind:"Folder",name:"nestjs",route:"/nestjs",children:[{kind:"MdxPage",name:"Authentication",route:"/nestjs/Authentication"},{kind:"MdxPage",name:"CardWebPay",route:"/nestjs/CardWebPay"},{kind:"MdxPage",name:"Controllers",route:"/nestjs/Controllers"},{kind:"MdxPage",name:"Kubernetes",route:"/nestjs/Kubernetes"},{kind:"MdxPage",name:"Logging",route:"/nestjs/Logging"},{kind:"MdxPage",name:"Module",route:"/nestjs/Module"},{kind:"MdxPage",name:"NestJS",route:"/nestjs/NestJS"},{kind:"MdxPage",name:"OpenAPI",route:"/nestjs/OpenAPI"},{kind:"MdxPage",name:"Prisma",route:"/nestjs/Prisma"},{kind:"MdxPage",name:"ProjectStructure",route:"/nestjs/ProjectStructure"},{kind:"MdxPage",name:"RestApi",route:"/nestjs/RestApi"},{kind:"MdxPage",name:"Sentry",route:"/nestjs/Sentry"},{kind:"MdxPage",name:"Services",route:"/nestjs/Services"},{kind:"MdxPage",name:"Testing",route:"/nestjs/Testing"},{kind:"Meta",data:{Authentication:"Authentication",CardWebPay:"Cardwebpay",Controllers:"Controllers",Kubernetes:"Kubernetes",Logging:"Logging",Module:"Module",NestJS:"Nestjs",OpenAPI:"Openapi",Prisma:"Prisma",ProjectStructure:"Projectstructure",RestApi:"Restapi",Sentry:"Sentry",Services:"Services",Testing:"Testing"}}]},{kind:"Folder",name:"onboarding",route:"/onboarding",children:[{kind:"Meta",data:{"editor-setup":"Editor Setup","docker-setup":"Docker / Podman Setup","wsl-setup":"Windows WSL Setup","kubernetes-lens-setup":"Kubernetes & Lens Setup","postgres-setup":"Postgres Setup",other:"Other Setups","--- Workflow ---":{type:"separator"},"developer-accesses":"Developer Accesses","git-workflow":"Git Workflow"}},{kind:"MdxPage",name:"developer-accesses",route:"/onboarding/developer-accesses"},{kind:"MdxPage",name:"docker-setup",route:"/onboarding/docker-setup"},{kind:"MdxPage",name:"editor-setup",route:"/onboarding/editor-setup"},{kind:"MdxPage",name:"git-workflow",route:"/onboarding/git-workflow"},{kind:"MdxPage",name:"kubernetes-lens-setup",route:"/onboarding/kubernetes-lens-setup"},{kind:"MdxPage",name:"other",route:"/onboarding/other"},{kind:"MdxPage",name:"postgres-setup",route:"/onboarding/postgres-setup"},{kind:"MdxPage",name:"wsl-setup",route:"/onboarding/wsl-setup"}]},{kind:"MdxPage",name:"openapi",route:"/openapi"},{kind:"Folder",name:"strapi",route:"/strapi",children:[{kind:"Meta",data:{"general-concepts":"General concepts","best-practices":"Best practices","make-content-public":"Make the content public",setup:"Setup","load-strapi-db-in-local-dev":"Load DB for local development","sync-strapi-db-to-different-env":"Sync DB between deployments"}},{kind:"MdxPage",name:"best-practices",route:"/strapi/best-practices"},{kind:"MdxPage",name:"general-concepts",route:"/strapi/general-concepts"},{kind:"MdxPage",name:"load-strapi-db-in-local-dev",route:"/strapi/load-strapi-db-in-local-dev"},{kind:"MdxPage",name:"make-content-public",route:"/strapi/make-content-public"},{kind:"MdxPage",name:"setup",route:"/strapi/setup"},{kind:"MdxPage",name:"sync-strapi-db-to-different-env",route:"/strapi/sync-strapi-db-to-different-env"}]}],flexsearch:{codeblocks:!0},title:"Deployment & Releases"},pageNextRoute:"/deployment-and-infrastructure/deployment-and-releases",nextraLayout:r.ZP,themeConfig:s.Z};function l(e){let n=Object.assign({h1:"h1",h2:"h2",p:"p",a:"a",strong:"strong",h3:"h3",h4:"h4",ul:"ul",li:"li",code:"code",ol:"ol",br:"br",em:"em"},(0,o.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"deployment--releases",children:"Deployment & Releases"}),"\n",(0,a.jsx)(n.h2,{id:"production-releases",children:"Production releases"}),"\n",(0,a.jsxs)(n.p,{children:["Most of our projects are set up to be ",(0,a.jsx)(n.a,{href:"https://www.docker.com/",children:"dockerized"})," and deployed into our Kubernetes infrastructure. This can be done semi-manually using ",(0,a.jsx)(n.a,{href:"https://github.com/bratislava/bratiska-cli",children:"bratiska-cli"})," tool, but primarily ",(0,a.jsx)(n.strong,{children:"should be done"})," by automatic GitHub pipelines."]}),"\n",(0,a.jsx)(n.h3,{id:"frontend--backend-apps",children:"Frontend / Backend apps"}),"\n",(0,a.jsx)(n.p,{children:"This assumes Github Actions CI/CD pipeline is in place - every project running in production should have those by now. If this is not the case, one should be setup. Afterwards:"}),"\n",(0,a.jsx)(n.h4,{id:"dev-and-staging-deployments",children:"DEV and STAGING deployments"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["✅ Deployments to STAGING are done automatically from the ",(0,a.jsx)(n.code,{children:"master"})," branch."]}),"\n",(0,a.jsx)(n.li,{children:"✅ Deployments to DEV cluster should by done by creating tags only, never through releases."}),"\n",(0,a.jsxs)(n.li,{children:["✅ Deployments to DEV have tags in format ",(0,a.jsx)(n.strong,{children:"devWHATEVER"})," i.e. ",(0,a.jsx)(n.strong,{children:"dev-testing-new-maplify-version"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release to staging manually."}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release to dev by creating a (pre-)release in Github."}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"prod-deployments",children:"PROD deployments"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["✅ Every production deployment should be created using a ",(0,a.jsx)(n.a,{href:"https://docs.github.com/en/repositories/releasing-projects-on-github/managing-releases-in-a-repository",children:"GitHub Release"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["✅ Format of the tag created with release is ",(0,a.jsx)(n.strong,{children:"prodMAJOR.MINOR.PATCH"})," i.e. ",(0,a.jsx)(n.strong,{children:"prod1.23.0"}),". When deploying only certain services from a monorepo setup, you can use ",(0,a.jsx)(n.strong,{children:"prod-service-nameMAJOR.MINOR.PATCH"}),", i.e. ",(0,a.jsx)(n.strong,{children:"prod-next1.23.0"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["✅ When releasing a backend consumed by multiple actors, follow ",(0,a.jsx)(n.a,{href:"https://semver.org",children:"semver"})," strictly."]}),"\n",(0,a.jsx)(n.li,{children:"✅ When releasing frontend apps or backends consumed by a single frontend, follow semver loosely - bump patch if it feels like a minor bugfix, minor if it feels like updating features, major to signify major changes. No strict rules about versioning apply in this case."}),"\n",(0,a.jsx)(n.li,{children:"✅ Always autogenerate release notes. Feel free to add anything relevant on top of those"}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release to prod from your local machine"}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release to prod by creating a tag"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"libraries",children:"Libraries"}),"\n",(0,a.jsx)(n.p,{children:"Github Actions CI/CD pipeline must be in place"}),"\n",(0,a.jsx)(n.h4,{id:"dos-and-donts",children:"Do's and Don'ts"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:'✅ Every production deployment should be created using a github "release".'}),"\n",(0,a.jsxs)(n.li,{children:["✅ Follow format of the tag created with release is ",(0,a.jsx)(n.strong,{children:"prodMAJOR.MINOR.PATCH"})," i.e. ",(0,a.jsx)(n.strong,{children:"prod1.23.0"})," - follow ",(0,a.jsx)(n.a,{href:"https://semver.org",children:"semver"})," strictly."]}),"\n",(0,a.jsx)(n.li,{children:"✅ Autogenerate release notes. Feel free to add anything relevant on top of those."}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release the library from your local machine."}),"\n",(0,a.jsx)(n.li,{children:"❌ Don't release the library by creating a tag."}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"native",children:"Native"}),"\n",(0,a.jsx)(n.p,{children:"TODO - if there's a standard approach we use on multiple native apps, please document here"}),"\n",(0,a.jsx)(n.h2,{id:"manual-deployment-using-bratiska-cli",children:"Manual deployment using bratiska-cli"}),"\n","\n",(0,a.jsxs)(n.p,{children:["You can find detailed manual & requirements in the ",(0,a.jsx)(n.a,{href:"https://github.com/bratislava/bratiska-cli#readme",children:"bratiska-cli README"}),". TLDR:"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"make sure you are signed into docker harbor"}),"\n",(0,a.jsx)(n.li,{children:"make sure your are signed into the correct Kubernetes cluster"}),"\n",(0,a.jsxs)(n.li,{children:["run ",(0,a.jsx)(n.code,{children:"bratiska-cli deploy --<env>"})," where ",(0,a.jsx)(n.code,{children:"<env>"})," is one of ",(0,a.jsx)(n.code,{children:"dev"}),", ",(0,a.jsx)(n.code,{children:"staging"}),", ",(0,a.jsx)(n.code,{children:"prod"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"harbor-policies",children:"Harbor Policies"}),"\n",(0,a.jsxs)(n.p,{children:["As we have a somewhat limited space in our Harbor instance, all repositories are subjected to retention policy.",(0,a.jsx)(n.br,{}),"\n","Currently, every project is entitled to 30 images altogether, split across different tags:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["5 ",(0,a.jsx)(n.em,{children:"latest"})," images with ",(0,a.jsx)(n.code,{children:"prod*"})," tag"]}),"\n",(0,a.jsxs)(n.li,{children:["5 ",(0,a.jsx)(n.em,{children:"latest"})," images with ",(0,a.jsx)(n.code,{children:"staging*"})," tag"]}),"\n",(0,a.jsxs)(n.li,{children:["10 ",(0,a.jsx)(n.em,{children:"latest"})," images with ",(0,a.jsx)(n.code,{children:"dev*"})," tag"]}),"\n",(0,a.jsxs)(n.li,{children:["10 ",(0,a.jsx)(n.em,{children:"latest"})," images with ",(0,a.jsx)(n.strong,{children:"some"})," tag"]}),"\n",(0,a.jsxs)(n.li,{children:["Images without ",(0,a.jsx)(n.strong,{children:"any"})," tags will be removed"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The policy is ran once a day at midnight, so during the day you might push more then specified limits. Also, please note that ",(0,a.jsx)(n.code,{children:"bratiska-cli"})," will automatically add ",(0,a.jsx)(n.code,{children:"dev-*"}),", ",(0,a.jsx)(n.code,{children:"staging-*"})," or ",(0,a.jsx)(n.code,{children:"prod-*"})," tags, so be careful when running production or staging pushes not to accidentally remove images currently deployed in production."]})]})}n.default=(0,i.j)(d)}},function(e){e.O(0,[9774,5840,2888,179],function(){return e(e.s=365)}),_N_E=e.O()}]);